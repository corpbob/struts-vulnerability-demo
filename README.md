# This is a sample project to demonstrate a vulnerability.


- Download tomcat 8

```
curl -LO http://mirror.rise.ph/apache/tomcat/tomcat-8/v8.5.54/bin/apache-tomcat-8.5.54.tar.gz
tar xzf apache-tomcat-8.5.54.tar.gz
cd apache-tomcat-8.5.54
export TOMCAT_HOME=$(pwd)
```

- Build the project

```
mvn clean package
```

- Copy the war file

```
cp target/hello-world.war $TOMCAT_HOME/webapps
```

- Start the tomcat

```
$TOMCAT_HOME/bin/catalina.sh run
```
 
- Open a browser and test the functionality of the upload
- Open another terminal and execute the curl.sh command

```
bash curl.sh
```
## Configure a Reverse Proxy

### Configure 2 Virtual Box VMs 

- Operating System: Centos 7.7.1908 or later
- Enable NAT and hostonly network
- VM1 ip address 192.168.56.2, netmask 255.255.255.0, hostname permissive
- VM2 ip address 192.168.56.3, netmask 255.255.255.0, hostname enforcing
- Install policycoreutils-python in both VMs

```
yum install -y policycoreutils-python
```

- Enable SELinux in VM2

```
setenforce 1
```

-- Edit the file /etc/selinux/config and make sure that the value of SELINUX is set to enforcing

- Set SELinux in VM2 to permissive

```
setenforce 0
```

-- Edit the file /etc/selinux/config and make sure that the value of SELINUX is set to permissive

- Install nginx on both  VMs
-- In the below, let 

  <vm ip> be equal to 192.168.56.2 if VM = VM1 
  <vm ip> be equal to 192.168.56.3 if VM = VM2

```
yum install epel-release
yum install nginx
```

- Edit /etc/nginx/nginx.conf and change the line from

```
      location / {
        }
```

to

```
      location / {
          proxy_pass http://<vm ip>:8080;
        }
```

- Enable nginx in both VMs

```
systemctl enable nginx
systemctl restart nginx
```

- In VM2, since SELinux is enabled, it will not allow the nginx to connect to the upstream server at VM2, so we enable a boolean to allow it to do so:

```
setsebool httpd_can_network_connect on
```

- Open ports 80 and 8080 in both VMs

```
firewall-cmd --add-port 80/tcp --permanent
firewall-cmd --add-port 8080/tcp --permanent
firewall-cmd --reload
```

- Now you can test via a browser by navigating to http://192.168.56.3/hello-world. You can try to upload a file

# Run the exploit on the Permissive. Note that 192.168.56.3 is the reverse proxy to the permissive VM.

```
bash curl.sh 192.168.56.3 80
```

# Deface the site. Edit the file curl.sh and change 

```
cat /etc/passwd
```

to

```
cd /home/tomcat/apache-tomcat-8.5.54/webapps/hello-world; sed -i \"13i Defaced\" upload.jsp
```

- Reload the browser at http://192.168.56.3/hello-world/ and notice that you defaced the site.

# Install tomcat as RPM

```
yum install -y tomcat
```

- Install SELinux policy devel

```
yum install -y selinux-policy-devel 
yum install setools-console -y
```

## Develop a custom policy for tomcat
make mytomcat.pp
semodule -r mytomcat
semodule -i mytomcat.pp 
systemctl start tomcat

# References
* [1] https://www.synopsys.com/blogs/software-security/equifax-apache-struts-vulnerability-cve-2017-5638/
* [2] https://nvd.nist.gov/vuln/detail/CVE-2017-5638#vulnCurrentDescriptionTitle
* [3] https://blog.trendmicro.com/trendlabs-security-intelligence/cve-2017-5638-apache-struts-vulnerability-remote-code-execution/#gallery-1
* [4] https://blog.talosintelligence.com/2017/03/apache-0-day-exploited.html
* [5] https://github.com/xsscx/cve-2017-5638
* [6] https://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-install-apache-tomcat-9-on-rhel-8.html#SELinux
