policy_module(mytomcat-mytomcatadm, 0.1)

gen_require(`
  type passwd_file_t;
  type unconfined_t;
  type fs_t;
  type mytomcatadm_t;
  type http_cache_port_t;
  type mxi_port_t;
  type unlabeled_t;
  type proc_net_t;
')

type mytomcat_tmp_t;
type mytomcat_var_lib_t;
type mytomcat_var_run_t;
type mytomcat_t;
type mytomcat_conf_t;
type mytomcat_log_t;
type mytomcat_exec_t;
type mytomcat_cache_t;

allow mytomcat_t self:process execmem;
allow mytomcat_t mytomcat_tmp_t:dir { getattr open read search write add_name remove_name };
allow mytomcat_t mytomcat_cache_t:dir { getattr search };
allow mytomcat_t mytomcat_log_t:dir { getattr search write };
allow mytomcat_t mytomcat_log_t:dir add_name;
allow mytomcat_t mytomcat_var_lib_t:dir read;
allow mytomcat_t fs_t:filesystem associate;

allow mytomcat_t mytomcat_tmp_t:file { write unlink create open };
allow mytomcat_t passwd_file_t:file { getattr open read };
allow mytomcat_t mytomcat_var_lib_t:file { getattr read open };

allow mytomcat_t self:tcp_socket listen;
allow mytomcat_t self:tcp_socket accept;
allow unconfined_t mytomcat_t:dir relabelto;
allow unconfined_t self:capability2 mac_admin;
allow unconfined_t mytomcat_t:file { relabelto relabelfrom getattr setattr read ioctl open map create append write unlink rename };
allow unconfined_t mytomcat_t:dir { relabelfrom getattr open read search remove_name unlink write add_name create rmdir setattr };


# allow unconfined_user to relabel mytomcat_tmp_t
allow unconfined_t mytomcat_tmp_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_tmp_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };
allow mytomcat_tmp_t fs_t:filesystem associate;

# allow unconfined_user to relabel mytomcat_var_lib_t
allow mytomcat_var_lib_t fs_t:filesystem associate;
allow unconfined_t mytomcat_var_lib_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_var_lib_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

# allow unconfined_user to relabel mytomcat_log_t
allow mytomcat_log_t fs_t:filesystem associate;
allow unconfined_t mytomcat_log_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_log_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

# allow unconfined_user to relabel mytomcat_conf_t
allow mytomcat_conf_t fs_t:filesystem associate;
allow unconfined_t mytomcat_conf_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_conf_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

# allow unconfined_user to relabel mytomcat_cache_t
allow mytomcat_cache_t fs_t:filesystem associate;
allow unconfined_t mytomcat_cache_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_cache_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

# allow unconfined_user to relabel mytomcat_var_run_t
allow mytomcat_var_run_t fs_t:filesystem associate;
allow unconfined_t mytomcat_var_run_t:dir { setattr relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_var_run_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

# allow unconfined_user to relabel mytomcat_exec_t
allow mytomcat_exec_t fs_t:filesystem associate;
allow unconfined_t mytomcat_exec_t:dir { relabelto getattr open read search remove_name unlink write add_name create rmdir };
allow unconfined_t mytomcat_exec_t:file { relabelto getattr setattr read ioctl open map create append write unlink rename };

#============= mytomcatadm_t ==============

allow mytomcatadm_t mytomcat_t:dir { getattr relabelto read open search relabelfrom setattr write add_name create remove_name search rmdir };
allow mytomcatadm_t mytomcat_var_run_t:dir { getattr read ioctl open create search };
allow mytomcatadm_t mytomcat_tmp_t:dir { ioctl getattr open read search remove_name unlink write add_name create };
allow mytomcatadm_t mytomcat_var_lib_t:dir { getattr read ioctl open create search };
allow mytomcatadm_t mytomcat_conf_t:dir { getattr read ioctl open create search write add_name };
allow mytomcatadm_t mytomcat_log_t:dir { getattr read ioctl open create search write add_name };
allow mytomcatadm_t mytomcat_exec_t:dir { create ioctl relabelto getattr read open relabelfrom search setattr write };
allow mytomcatadm_t mytomcat_cache_t:dir { getattr read ioctl open create search write add_name remove_name };


allow mytomcatadm_t self:capability2 mac_admin;
allow mytomcatadm_t http_cache_port_t:tcp_socket name_bind;
allow mytomcatadm_t mxi_port_t:tcp_socket name_bind;
allow mytomcatadm_t unlabeled_t:file append;

# files
allow mytomcatadm_t mytomcat_t:file { relabelto getattr relabelfrom setattr read ioctl open map create append write unlink rename };
allow mytomcatadm_t mytomcat_var_run_t:file { getattr read open map create unlink write setattr };
allow mytomcatadm_t mytomcat_tmp_t:file { getattr read open create write unlink };
allow mytomcatadm_t mytomcat_var_lib_t:file { getattr read open map };
allow mytomcatadm_t mytomcat_conf_t:file { getattr read open };
allow mytomcatadm_t mytomcat_log_t:file { getattr read open create append };
allow mytomcatadm_t mytomcat_exec_t:file { relabelto getattr relabelfrom setattr ioctl read open getattr map execute execute_no_trans};
allow mytomcatadm_t mytomcat_cache_t:file { getattr read open create write setattr unlink rename };

allow mytomcatadm_t proc_net_t:file read;

#!!!! This avc can be allowed using the boolean 'nis_enabled'
allow mytomcatadm_t http_cache_port_t:tcp_socket name_connect;
allow mytomcatadm_t proc_net_t:file open;

#!!!! This avc can be allowed using the boolean 'nis_enabled'
allow mytomcatadm_t self:tcp_socket accept;
allow mytomcatadm_t self:tcp_socket listen;

